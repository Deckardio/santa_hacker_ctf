# Forensic

![[task_leak.png]]

Для анализа трафика воспользуемся ПО [Wireshark](https://www.wireshark.org/). Сразу подгружаем сессионные ключи в настройках протокола TLS. Среди легитимных запросов внимание привлекают только странные HTTP-сессии с адресатом `151.101.84.223`, где в качестве значения GET-параметра id передаются какие-то закодированные/зашифрованные данные.

![[wareshark_leak_all.png]]

Анализ DNS-запросов дает понять, что в данный адрес резолвится доменное имя dualstack.python.map.fastly.net, которое является CNAME для pypi.python.org.

![[wireshark_leak_pac.png]]

Тут стоит подчеркнуть, что репозиторий модулей Python использует сеть CDN Fastly. Но является ли этот ресурс вредоносным? Нет.

После анализа HTTP-заголовков внимание привлекает значение атрибута Host, которое имеет значение malw22.imkt.site.global.prod.fastly.net.

Переход по данному адресу дает нам ответ на поставленную задачу.

![[leak_site.png]]

Фишка данного подхода в том, что злоумышленник использовал особенности работы CDN Fastly (а точнее кеширующего прокси сервера Varnish, который находится у него под капотом) для эксфильтрации данных через легитимный ресурс и последующего редиректра на вредоносный сервер. Данная техника ранее была выявлена исследователями безопасности при анализе вредоносного Python модуля importantpackage в репозитории PyPI.

Что почитать:
- Подробнее про технику «Abusing CDN TLS termination» для эксфильтрации данных: https://jfrog.com/blog/python-malware-imitatessigned-pypi-traffic-in-novel-exfiltration-technique/