# Crypto

![[elf.png]]

Нам дан открытый ключ и зашифрованный файл.

Открытый ключ содержит следующие значения:
`n: 54480662578076527470362713889486540748591255021354202965062029859315189978396605669090149909442436671219347302674891793471105845564379619951172777856559350723521047110374941020970842839855492104554845759671790168884911066200643155106617193241663991199835668973820397856942107803308420028326687835768515214777667811777301841184983635486861185606882962384804309051935954059617001288151810813430647200120955422451190852362033129362999456763316092307851532478712604363997229324890928231743561589383273771046819398109277725236276142862880607175974306347753022257321686276100675601335806257289822950475793086410987221872524313188824308283247559641434105538204339751038856615317879795535443374019421017573566160533427842796382645257612906381492293282290091167114882841499126596308310511811133517609760659106620077166892719710914816892377037795214060015412756186782022678759094018594923979107940561496799473525514973415765755988462285640837133437132794588769484115758345488712834389335879569948749343202759878091651313990065628228749899051654855861909331443278230101350600870163133464886844141009851862856542323110761269195163793292996165107980180262727723511428917816492220750277645962298776797600494951333667625344584228921383503930551975304974574547999422721901663712035432220321550490240903907100360529020641623080876923869185279195681262218668839864737505736710206607486911531025561094261548468863281563685419483112294522066621545654209819630729109439974566550367158285111558035205190151293969910755432001132582172707112666592558867149388201914564895627161565431644032190538022123127657619003394037031337278353107142433312044075864689614937308952650399934356178235988492338776361406063121639109865757863881574108696140718725257319281225590679935121087856822217023327332815745205420089147292090772393749013596636370275370599769769109143035582453521095359269999855355079787997346384320603213011038589359094814741908976449748350484578664207026761891970239156797131863132566708791641536507750329437545587756648022566388299076343794399831641584832650988358722848996373478785488195968385132463882208534190268505129930517550086010130457339905866829931292757470174100244390627674854278375731265389589854644671154749136163469076240220156880259297040239010487640861968021534152049267804780642988330520556274512536479460210687058150668175789327707131915895384517507807866017960819646765726083807673637903860856497266318537119000663680614845720866964513910465439613131483104774794192030552306409711825326494324315144802337453958784590818095393764480271054649775782188744901307027663871874871746470590469320230424450955567169537
e: 65537`

Получить их можно импортировав значения `public.pem`  через библиотеку `rsa`

```python
import rsa
with open('public.pem', 'r') as fo:
	data_pub = fo.read()
	public = rsa.PublicKey.load_pkcs1_openssl_pem(data_pub)
	print(f'n: {public.n}')
	print(f'e: {public.e}')
```
		
В базе [Factordb](http://factordb.com/) значение `n` отсутствует, а возможных вариантов атак на RSA множество. Тут можно воспользоваться утилитой [RSACtfTool](https://github.com/Ganapati/RsaCtfTool)

Нам необходимы параметры для атаки, а именно `n`, `e` и `c`. Импортируем все полученные параметры в `RsaCtfTool.py` , при этом мы можем напрямую задать файл открытого ключа и зашифрованный файл (отобразил только начало и конец строк, чтобы не листать километровый вывод):

```bash
$ python3 RsaCtfTool.py --publickey public.pem --dumpkey --uncipherfile flag.enc
private argument is not set, the private key will not be displayed, even if recovered.

[*] Testing key public.pem.
[*] Performing mersenne_primes attack on public.pem.
[*] Attack success with mersenne_primes method !

esults for public.pem:
n: 5448...169537
e: 65537
d: 85...9153
p: 190...4991
q: 28554...0607

Public key details for public.pem
n: 544...69537
e: 65537

Unciphered data :
HEX : 0x000...07d
INT (big endian) : 348...6429
INT (little endian) : 426...5184
STR : b'\x00\...IMKT{mer5enne_prim35_4r0m_s@nt@}'
```
Получаем наш фаг в конце сообщения **IMKT{mer5enne_prim35_4r0m_s@nt@}**

Как мы видим, что данный публичный ключ уязвим к *Mersenne primes attack*

Возникает вопрос, а почему атака работает. Простое число Мерсена имеет вид $$M_p=2^p-1$$ в котором `p` является простым числом. Код генерации взят с [тырнетов](https://stackoverflow.com/questions/45195059/efficient-mersenne-prime-generator-in-python)

```python
def lucas_lehmer(p):
    s = 4
    m = 2 ** p - 1
    for _ in range(p - 2):
        s = ((s * s) - 2) % m
    return s == 0

def is_prime(number):
    """
    the efficiency of this doesn't matter much as we're
    only using it to test the primeness of the exponents
    not the mersenne primes themselves
    """

    if number % 2 == 0:
        return number == 2

    i = 3
    while i * i <= number:
        if number % i == 0:
            return False
        i += 2

    return True

print(3)  # to simplify code, treat first mersenne prime as a special case

for i in range(3, 5000, 2):  # generate up to M20, found in 1961
    if is_prime(i) and lucas_lehmer(i):
        print(2 ** i - 1)
```

